var $btnCallout;var $btnHandup;var $btnMute;var $btnHold;var ctx="";var listeningFlg=false;function init(){$btnCallout=$("#calloutBtn");$btnHandup=$("#handupBtn");$btnMute=$("#muteBtn");$btnHold=$("#holdBtn");var a=0;$btnCallout.bind("click",function(){onclickCallOut(a)});$btnHandup.bind("click",function(){onclickOnHand(a)});$btnMute.bind("click",function(){onclickSwitchMute(a)});$btnHold.bind("click",function(){onclickSwitchHold(a)});UsbPhone.Init();if(UsbPhone.GetPhoneState(a)==0){$("#phoneStatus").val(0);$btnHandup.attr("disabled",true);$btnMute.attr("disabled",true);$btnHold.attr("disabled",true)}else{if(UsbPhone.GetPhoneState(a)==1){$("#phoneStatus").val(1);$btnCallout.attr("disabled",true)}else{$btnHandup.attr("disabled",true);$btnMute.attr("disabled",true);$btnHold.attr("disabled",true)}}}var inComingFlg=false;var itv;var ringArray=new Array();function handleInComingFlg(){var b=0;var a=0;itv=setInterval(function(){if(a==ringArray.length){b++;if(b>9){clearInterval(itv);ringArray.splice(0,ringArray.length);inComingFlg=false;$("#inComingHandleBtns").html('<span class="btn"><i class="icon-call-end"></i> 已挂断 </span>')}}if(a!=ringArray.length){b=0}a=ringArray.length},500)}function OnIncomingPhone(a,b){if(inComingFlg){return}inComingFlg=true;handleInComingFlg();var a=0;if(ctx===undefined){ctx=""}$.ajax({type:"post",url:ctx+"/base/haCallRecord/indentify",data:{phoneNum:b},dataType:"json",success:function(c){if(c.data.status==0){var d=c.data.data;showIncomingPhoneInfo(b,d);$.ajax({type:"post",url:ctx+"/base/haCallRecord/create",data:{customerId:d.id,callInitiator:"C"},dataType:"json",success:function(e){if(e.data.status==0){var f=e.data.data;$("#callRecordId").val(f.callRecordId)}else{showBnInfo("通话日志记录异常！")}}})}else{}}})}function clickPhoneNumCallOut(a,c){var b=0;$.ajax({type:"post",url:ctx+"/base/haCallRecord/create",data:{customerId:a,callInitiator:"H",cardId:c},dataType:"json",success:function(d){if(d.data.status==0){var f=d.data.data;var e=f.mobile;if(UsbPhone.Dial(b,e)!=0){showBnInfo("呼出成功：号码:"+e)}else{showBnInfo("呼叫失败：号码:"+e)}$("#callRecordId").val(f.callRecordId)}else{showBnInfo("通话日志记录异常！")}}})}function clickRecordFile(d){if(!listeningFlg){var c=0;var b="C:\\SF_TEDERIC\\records\\"+d+".wav";var a=1;if(UsbPhone.StartRecordFile(c,b,a)!=0){listeningFlg=true}}}function clickStopRecord(){var b=0;if(UsbPhone.StopRecord(b)!=0){if($("#callRecordId").val()!=""){if(listeningFlg){var c;if(c==undefined){c=new ActiveXObject("WScript.Shell")}var a=c.Run("C:/SF_TEDERIC/script/upload.bat",0,false);console.log(a);listeningFlg=false}}}}function onclickCallIn(a){showBnInfo("");if($("#phoneStatus").val()!=0){showBnInfo("设备状态异常！");return}UsbPhone.Init();UsbPhone.OffHand(a)}function onclickCallOut(b){showBnInfo("");var a=$("#phoneNum").val();if(a.length<1){showBnInfo("号码错误！");return}if($("#phoneStatus").val()!=0){showBnInfo("设备状态异常！");return}console.log(111111);$btnCallout.attr("disabled",true);$.ajax({type:"post",url:ctx+"/system/callLog/create",data:{phoneNum:a,callType:"O"},dataType:"json",success:function(c){if(c.state=="ok"){var d=c.data;if(d>0){UsbPhone.Init();if(UsbPhone.Dial(b,a)!=0){$btnHandup.attr("disabled",false);$btnMute.attr("disabled",false);$btnHold.attr("disabled",false);showBnInfo("呼出成功：号码:"+a)}else{showBnInfo("呼叫失败：号码:"+a)}}}else{showBnInfo("通话日志记录异常！")}}})}function onclickOnHand(b){UsbPhone.Init();if(UsbPhone.GetPhoneState(b)==0){var a=UsbPhone.OffHand(b);if(a!=0){setTimeout(function(){var c=UsbPhone.OnHand(b);showBnInfo("挂机成功!")},500)}}else{if(UsbPhone.OnHand(b)!=0){$btnCallout.attr("disabled",false);$btnHandup.attr("disabled",true);$btnMute.attr("disabled",true);$btnHold.attr("disabled",true);showBnInfo("挂机成功！")}else{showBnInfo("挂机失败！")}}}function onclickSwitchMute(d){var c=$("#muteStatus").val();var b;if(c==0){b=1;$btnMute.text("关闭闭音")}else{b=0;$btnMute.text("开启闭音")}UsbPhone.Init();var a=UsbPhone.Mute(d,b);if(a!=0){$("#muteStatus").val(b);showBnInfo("闭音"+(b==1?"开启":"关闭"))}}function onclickSwitchHold(c){var d=$("#holdStatus").val();var b;if(d==0){b=1;$btnHold.text("关闭保留")}else{b=0;$btnHold.text("开启保留")}UsbPhone.Init();var a=UsbPhone.Hold(c,b);if(a!=0){$("#holdStatus").val(b);showBnInfo("保留"+(b==1?"开启":"关闭"))}}function showBnInfo(a){if(a!=""){messageBox(a)}}function showIncomingPhoneInfo(d,c){if(ctx===undefined){ctx=""}layer.closeAll("page");var g=0;var a=c.customerName;var f="";var e=d;if(c.alipayUserAvatar!=""&&c.alipayUserAvatar!=null){f=c.alipayUserAvatar}else{if(c.pwAvatarUrl!=""&&c.pwAvatarUrl!=null){f=c.pwAvatarUrl}else{if(c.userAvatar!=""&&c.userAvatar!=null){f=ctx+"/attach/download?attachId="+c.userAvatar}else{f=ctx+"/assets/img/user.png"}}}var b='<div class="row m-b-lg" style="width:300px;">	<div class="col-lg-4 text-center">		<div class="m-b-sm">			<img class="img-circle" src="'+f+'" style="width: 64px;border-radius: 50% !important;margin-top:10px;margin-left:20px;">		</div>	</div>	<div class="col-lg-6" style="left:20px;">		<div style="font-size: 17px; margin-top: 10px;">'+a+'</div>		<div style="font-size: 17px; margin-top: 8px; margin-bottom: 20px;">'+e+'</div>	</div>	<div class="col-lg-6">		<button type="button" class="btn btn-primary btn-sm btn-block" onclick="onclickCallIn('+g+')" style="margin: 0px 10px;"> 接听</button>	</div>	<div class="col-lg-6">		<button type="button" class="btn btn-danger btn-sm btn-block" onclick="onclickOnHand('+g+')" style="margin: 0px 10px;"> 挂断</button>	</div></div>';layer.open({type:1,title:false,closeBtn:2,shade:0,area:"300px",scrollbar:true,offset:"rb",anim:2,content:b,end:function(){}})}function OnPhoneRing(b,a){ringArray.push(a);if(a!=0){}}function OnStopLiuyan(a){showBnInfo("指定的终端设备按“摘机”键停止留言录音:"+a)}function OnMuteKey(b,a){if(a==1){$btnMute.text("关闭闭音");$("#muteStatus").val(1)}else{if(a==0){$btnMute.text("开启闭音");$("#muteStatus").val(0)}}}function OnHoldKey(a,b){if(b==1){$btnMute.text("关闭保留");$("#holdStatus").val(1)}else{if(b==0){$btnMute.text("开启保留");$("#holdStatus").val(0)}}}function OnPhoneStateChange(d,c){var b;layer.closeAll("page");if(c==0){showBnInfo("通话结束！");var a=$("#callRecordId").val();console.log("------------->挂断电话，callRecordId："+a);if(a!=""){$.ajax({type:"post",url:ctx+"/base/haCallRecord/finishCall",data:{id:a},dataType:"json",success:function(e){if(e.data.status==0){var f=e.data.data.id;clickStopRecord();if(f!=""){$("#callRecordId").val("")}}else{showBnInfo("通话日志记录异常！")}}})}}else{if(c==1){if(itv!=undefined&&itv>0){clearInterval(itv);ringArray.splice(0,ringArray.length);inComingFlg=false;itv=-1}$("#phoneStatus").val(1);showBnInfo("通话中!");var a=$("#callRecordId").val();console.log("------------->接通电话，callRecordId："+a);if(a!=""){$.ajax({type:"post",url:ctx+"/base/haCallRecord/inCall",data:{id:a},dataType:"json",success:function(e){if(e.data.status==0){var f=e.data.data.id;clickRecordFile(f);if(f!=""){$("#callRecordId").val(f)}}else{showBnInfo("通话日志记录异常！")}}})}}else{if(c==2){showBnInfo("退出保留：坐席:"+d)}}}}function registerUsbPhoneEvents(){var buffer=new Array();buffer.push("function UsbPhone::OnIncomingPhone(lAudioDeviceID,IncomingNum)");buffer.push("{");buffer.push("   OnIncomingPhone(lAudioDeviceID,IncomingNum);");buffer.push("};");buffer.push("function UsbPhone::OnDeviceDetect(bState,lAudioDeviceID)");buffer.push("{");buffer.push("   OnDeviceDetect(bState,lAudioDeviceID);");buffer.push("};");buffer.push("function UsbPhone::OnPhoneRing(lAudioDeviceID,bState)");buffer.push("{");buffer.push("   OnPhoneRing(lAudioDeviceID,bState);");buffer.push("};");buffer.push("function UsbPhone::OnStopLiuyan(lAudioDeviceID)");buffer.push("{");buffer.push("   OnStopLiuyan(lAudioDeviceID);");buffer.push("};");buffer.push("function UsbPhone::OnMuteKey(lAudioDeviceID,bStatus)");buffer.push("{");buffer.push("   OnMuteKey(lAudioDeviceID,bStatus);");buffer.push("};");buffer.push("function UsbPhone::OnHoldKey(lAudioDeviceID,param)");buffer.push("{");buffer.push("   OnHoldKey(lAudioDeviceID,param);");buffer.push("};");buffer.push("function UsbPhone::OnPhoneStateChange(lAudioDeviceID,bState)");buffer.push("{");buffer.push("   OnPhoneStateChange(lAudioDeviceID,bState);");buffer.push("};");eval(buffer.join(""))}function clickFlashTime(){var d=0;var b=$("#selectFlashTime option:selected");var a=b.val();var c=b.text();UsbPhone.Init();if(UsbPhone.SetFlashTime(d,a)==1){showBnInfo("闪断时间设置为"+c)}else{showBnInfo("闪断时间设置失败")}}function clickHangup(){var a=0;UsbPhone.Init();if(UsbPhone.OnHand(a)!=0){$btnHangup.attr("disabled","disabled");$btnCallOut.removeAttr("disabled");$btnSetIdle.attr("disabled","disabled");$btnVOIPIO.removeAttr("disabled");showBnInfo("挂机成功=>坐席:"+a)}else{showBnInfo("挂机失败=>坐席:"+a)}}function clickPhoneState(){var a=0;if(UsbPhone.GetPhoneState(a)==0){showBnInfo("挂机状态")}else{if(UsbPhone.GetPhoneState(a)==1){showBnInfo("摘机状态")}else{showBnInfo("失败")}}}function OnStopLiuyan(a){showBnInfo("停止留言录音:"+a)}function clickOffHand(){var b=document.getElementById("btnSetIdle");var f=b.style.background;var d=f.substring(4,f.length-1);var c=0;if(d=="./image/Uc3_p1_27.jpg"){UsbPhone.Init();var a=UsbPhone.OffHand(c);if(a!=0){b.style.background="url(./image/Uc3_p1_21.jpg)";showBnInfo("摘机成功=>坐席:"+c)}}else{if(d=="./image/Uc3_p1_21.jpg"){UsbPhone.Init();var e=UsbPhone.OnHand(c);if(e!=0){$btnCallOut.removeAttr("disabled");$btnVOIPIO.removeAttr("disabled");$btnSetIdle.attr("disabled","disabled");$btnTalkRecIO.attr("disabled","disabled");$btnCloseSound.attr("disabled","disabled");$btnKeep.attr("disabled","disabled");$btnLeave.attr("disabled","disabled");document.getElementById("btnTalkRecIO").style.background="url(./image/Uc3_p1_5.jpg)";document.getElementById("btnStartRecording").style.background="url(./image/Uc3_p1_14.jpg)";document.getElementById("btnCloseSound").style.background="url(./image/Uc3_p1_15.jpg)";document.getElementById("btnKeep").style.background="url(./image/Uc3_p1_12.jpg)";document.getElementById("btnLeave").style.background="url(./image/Uc3_p1_10.jpg)";b.style.background="url(./image/Uc3_p1_27.jpg)";showBnInfo("挂机成功=>坐席:"+c)}else{showBnInfo("挂机失败=>坐席:"+c)}}}}function clickFlash(){var b=0;var a=3;UsbPhone.Init();if(UsbPhone.Flash(b,a)!=0){showBnInfo("闪断成功")}else{showBnInfo("闪断失败")}}function clickRingSet(){var d=document.getElementById("btnBill");var g=d.style.background;var f=g.substring(4,g.length-1);var e=0;var b=$btnBill.val();if(f=="./image/Uc3_p1_9.jpg"){var a=1;UsbPhone.Init();var c=UsbPhone.RingSet(e,a);if(c!=0){showBnInfo("打开特色铃声");d.style.background="url(./image/Uc3_p1_8.jpg)"}}else{if(f=="./image/Uc3_p1_8.jpg"){var a=0;UsbPhone.Init();var c=UsbPhone.RingSet(e,a);if(c!=0){showBnInfo("关闭特色铃声");d.style.background="url(./image/Uc3_p1_9.jpg)"}}}}function clickTalkRecIO(){var c=document.getElementById("btnTalkRecIO");var g=c.style.background;var f=g.substring(4,g.length-1);var b=$btnTalkRecIO.val();var e=0;if(f=="./image/Uc3_p1_5.jpg"){var a=1;UsbPhone.Init();var d=UsbPhone.SetTalkRecIO(e,a);if(d!=0){showBnInfo("打开通话录音io口");$btnStartRecording.removeAttr("disabled");c.style.background="url(./image/Uc3_p1_3.jpg)"}}else{if(f=="./image/Uc3_p1_3.jpg"){var a=0;UsbPhone.Init();var d=UsbPhone.SetTalkRecIO(e,a);if(d!=0){showBnInfo("关闭通话录音io口");c.style.background="url(./image/Uc3_p1_5.jpg)"}}}}function clickOutcode(){var a=0;var b=$("#outcode").val();UsbPhone.Init();if(UsbPhone.SetOutcode(a,b)!=0){showBnInfo("设置出局码成功,出局码:"+b)}else{showBnInfo("设置出局码失败")}}function clickCloseSound(){var a=document.getElementById("btnCloseSound");var g=a.style.background;var f=g.substring(4,g.length-1);var b=$btnCloseSound.val();var e=0;if(f=="./image/Uc3_p1_15.jpg"){var d=1;UsbPhone.Init();var c=UsbPhone.Mute(e,d);if(c!=0){showBnInfo("开启闭音")}}else{if(f=="./image/Uc3_p1_16.jpg"){var d=0;UsbPhone.Init();var c=UsbPhone.Mute(e,d);if(c!=0){showBnInfo("关闭闭音");a.style.background="url(./image/Uc3_p1_15.jpg)"}}}}function clickAutoAnswerOpen(){var d=0;var a=$btnAnswer.val();if(VOIP=="./image/Uc3_p1_4.jpg"){var c=1;UsbPhone.Init();var b=UsbPhone.SetAutoAnswer(d,c);if(b!=0){showBnInfo("开启自动接听");Answer.style.background="url(./image/Uc3_p1_2.jpg)"}}else{if(VOIP=="./image/Uc3_p1_2.jpg"){var c=0;UsbPhone.Init();var b=UsbPhone.SetAutoAnswer(d,c);if(b!=0){showBnInfo("取消自动接听");Answer.style.background="url(./image/Uc3_p1_4.jpg)"}}}}function addEventHandler(c,a,b){if(c.addEventListener){c.addEventListener(a,b,false)}else{if(c.attachEvent){c.attachEvent("on"+a,b)}else{c["on"+a]=b}}}function removeEventHandler(c,a,b){if(c.removeEventListener){c.removeEventListener(a,b,false)}else{if(c.detachEvent){c.detachEvent("on"+a,b)}else{delete c["on"+a]}}}var OnDeviceDetect=function(a,b){if(!a){showBnInfo("设备已拔出!")}else{}};window.console=window.console||(function(){var a={};a.log=a.warn=a.debug=a.info=a.error=a.time=a.dir=a.profile=a.clear=a.exception=a.trace=a.assert=function(){};return a})();$(window).load(function(){if(window.ActiveXObject||"ActiveXObject" in window){$(".showIfIE").each(function(){$(this).show()});var a=document.getElementById("UsbPhone");try{registerUsbPhoneEvents();addEventHandler(a,"DeviceDetect",OnDeviceDetect);var c=a.Init();if(c<0){return false}init()}catch(b){console.error(b)}}else{$(".showIfIE").each(function(){$(this).hide()})}});